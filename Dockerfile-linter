FROm debian:stretch as kafka-builder

RUN apt-get update -y
RUN apt-get install -y git make g++ zlib1g-dev libssl-dev libsasl2-dev libzstd-dev

WORKDIR /librdkafka

RUN git clone -b v1.3.0 https://github.com/edenhill/librdkafka .

RUN ./configure
RUN make
RUN make install

FROM golang:1.13-stretch as linter-builder

RUN GOPATH=$(mktemp -d) cd $(mktemp -d); \
    go mod init tempmod; \
    echo 'replace github.com/go-critic/go-critic => github.com/go-critic/go-critic c3db6069acc5' >> go.mod && \
    echo 'replace github.com/golangci/errcheck => github.com/golangci/errcheck ef45e06d44b6' >> go.mod && \
    echo 'replace github.com/golangci/go-tools => github.com/golangci/go-tools af6baa5dc196' >> go.mod && \
    echo 'replace github.com/golangci/gofmt => github.com/golangci/gofmt 0b8337e80d98' >> go.mod && \
    echo 'replace github.com/golangci/gosec => github.com/golangci/gosec 66fb7fc33547' >> go.mod && \
    echo 'replace github.com/golangci/lint-1 => github.com/golangci/lint-1 297bf364a8e0' >> go.mod && \
    echo 'replace mvdan.cc/unparam => mvdan.cc/unparam fbb59629db34' >> go.mod && \
    go get github.com/golangci/golangci-lint/cmd/golangci-lint@v1.21.0

FROM golang:1.13-stretch

COPY --from=linter-builder go/bin/golangci-lint /usr/local/bin/golangci-lint

COPY --from=kafka-builder /usr/local/include/librdkafka /usr/local/include/librdkafka
COPY --from=kafka-builder /usr/local/lib/librdkafka*.* /usr/local/lib/
COPY --from=kafka-builder /usr/local/lib/pkgconfig /usr/local/lib/pkgconfig

CMD exit 1