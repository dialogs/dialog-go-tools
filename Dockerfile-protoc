FROM debian:stretch as protoc

ARG DIR=/var/build

RUN apt-get update -y

# source:
# https://github.com/protocolbuffers/protobuf/tree/master/src
RUN apt-get install -y autoconf automake libtool curl make g++ unzip git

RUN git clone https://github.com/protocolbuffers/protobuf.git $DIR

WORKDIR $DIR

RUN git submodule update --init --recursive
RUN ./autogen.sh

RUN ./configure
RUN make
RUN make check
RUN make install

FROM golang:1.12-stretch

COPY --from=protoc /usr/local/include/google /usr/local/include/google
COPY --from=protoc /usr/local/bin/protoc /usr/local/bin/protoc
COPY --from=protoc /usr/local/lib/libproto* /usr/local/lib/
COPY --from=protoc /usr/local/lib/pkgconfig /usr/local/lib/pkgconfig

RUN ldconfig # refresh shared library cache.

# source:
# https://github.com/gogo/protobuf#more-speed-and-more-generated-code
RUN go get github.com/gogo/protobuf/proto
RUN go get github.com/gogo/protobuf/protoc-gen-gogoslick
RUN go get github.com/gogo/protobuf/protoc-gen-gogofaster
RUN go get github.com/gogo/protobuf/protoc-gen-gogofast
RUN go get github.com/gogo/protobuf/gogoproto

CMD exit 1